<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="CBOR and JSON (de)serialization in Scala">
<meta name="generator" content="Paradox, paradox-material-theme=0.7.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="CBOR and JSON (de)serialization in Scala">
<link rel="shortcut icon" href="../assets/images/favicon.ico">
<title>Derivation FAQ Â· borer</title>
<link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../assets/stylesheets/application-palette.22915126.css">
<meta name="theme-color" content="#3f51b5" />
<link rel="stylesheet" href="../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../lib/prettify/prettify.css">
<script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../assets/stylesheets/paradox-material-theme.css">
<link rel="stylesheet" href="../assets/stylesheets/borer.css">
</head>
<body
data-md-color-primary="indigo"
data-md-color-accent="orange"
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../index.html" title="borer" class="md-header-nav__button md-logo">
<img src="../assets/images/borer-logo-white.svg" width="24" height="24">
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
borer
</span>
<span class="md-header-nav__topic">
Derivation FAQ
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/sirthias/borer/"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
sirthias/borer/
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../index.html" title="borer" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<img src="../assets/images/borer-logo-white.svg" width="24" height="24">
</a>
<a href="../index.html" title="borer">
borer
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/sirthias/borer/"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
sirthias/borer/
</div>
</a>

</div>
<ul>
  <li><a href="../design-principles.html" class="page">Basic Design Principles and Limitations</a></li>
  <li><a href="../getting-started.html" class="page">Getting Started</a></li>
  <li><a href="../borer-core/index.html" class="page"><code>borer-core</code></a>
  <ul>
    <li><a href="../borer-core/encoding-and-decoding.html" class="page">Encoding and Decoding</a></li>
    <li><a href="../borer-core/supported-types.html" class="page">Types Supported Out-of-the-Box</a></li>
    <li><a href="../borer-core/custom-types.html" class="page">Encoding and Decoding Custom Types</a></li>
    <li><a href="../borer-core/nullable-and-default.html" class="page">Nullable and Default</a></li>
    <li><a href="../borer-core/StringNumbers.html" class="page"><code>StringNumbers</code> and <code>StringBooleans</code></a></li>
    <li><a href="../borer-core/ByteStringArrayCodecs.html" class="page"><code>ByteStringArrayCodecs</code></a></li>
    <li><a href="../borer-core/supporting-typeclasses.html" class="page"><code>Input</code>, <code>Output</code>, <code>ByteAccess</code></a></li>
    <li><a href="../borer-core/JSON-specifics.html" class="page">JSON Specifics</a></li>
    <li><a href="../borer-core/JSON-performance.html" class="page">JSON Performance</a></li>
    <li><a href="../borer-core/DOM.html" class="page">Document Object Model (DOM)</a></li>
    <li><a href="../borer-core/transcoding.html" class="page">Transcoding</a></li>
    <li><a href="../borer-core/debugging.html" class="page">Debugging</a></li>
  </ul></li>
  <li><a href="../borer-derivation/index.html" class="page"><code>borer-derivation</code></a>
  <ul>
    <li><a href="../borer-derivation/basics.html" class="page">Derivation Basics</a></li>
    <li><a href="../borer-derivation/array-based.html" class="page">Array-Based Codecs</a></li>
    <li><a href="../borer-derivation/map-based.html" class="page">Map-Based Codecs</a></li>
    <li><a href="../borer-derivation/type-ids.html" class="page">Type IDs</a></li>
    <li><a href="../borer-derivation/faq.html" class="active page">Derivation FAQ</a></li>
  </ul></li>
  <li><a href="../borer-compat-akka.html" class="page"><code>borer-compat-akka</code></a></li>
  <li><a href="../borer-compat-pekko.html" class="page"><code>borer-compat-pekko</code></a></li>
  <li><a href="../borer-compat-cats.html" class="page"><code>borer-compat-cats</code></a></li>
  <li><a href="../borer-compat-circe.html" class="page"><code>borer-compat-circe</code></a></li>
  <li><a href="../borer-compat-scodec.html" class="page"><code>borer-compat-scodec</code></a></li>
  <li><a href="../project/index.html" class="page">Project Info</a>
  <ul>
    <li><a href="../project/license.html" class="page">License</a></li>
    <li><a href="../project/changelog.html" class="page">Changelog</a></li>
    <li><a href="../project/references.html" class="page">References</a></li>
    <li><a href="../project/sponsors.html" class="page">Sponsors</a></li>
  </ul></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../borer-derivation/faq.html#derivation-faq" class="header">Derivation FAQ</a>
  <ul>
    <li><a href="../borer-derivation/faq.html#custom-overrides" class="header">Custom Overrides</a></li>
    <li><a href="../borer-derivation/faq.html#explicit-upcasts" class="header">Explicit Upcasts</a></li>
    <li><a href="../borer-derivation/faq.html#recursive-adts" class="header">Recursive ADTs</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 1.16.0
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../borer-derivation/faq.html#derivation-faq" class="header">Derivation FAQ</a>
  <ul>
    <li><a href="../borer-derivation/faq.html#custom-overrides" class="header">Custom Overrides</a></li>
    <li><a href="../borer-derivation/faq.html#explicit-upcasts" class="header">Explicit Upcasts</a></li>
    <li><a href="../borer-derivation/faq.html#recursive-adts" class="header">Recursive ADTs</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#derivation-faq" name="derivation-faq" class="anchor"><span class="anchor-link"></span></a>Derivation FAQ</h1>
<p>Fully-automatic derivation (via the <code>deriveAll...</code> macros) comes with a few special cases/gotchas that are detailed on this page.</p>
<h3><a href="#custom-overrides" name="custom-overrides" class="anchor"><span class="anchor-link"></span></a>Custom Overrides</h3>
<p>Fully-automatic derivation of encoders/decoders for ADTs allows for providing custom codecs for a subsets of the type hierarchy. If an implicit typeclass for a certain sub-type is already available at the <code>deriveAll...</code> macro call site then this implicit will be used rather than a new (and potentially conflicting) one generated.</p>
<p>Example:</p>
<pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/sirthias/borer/tree/master/site/src/test/scala/io/bullet/borer/site/DerivationSpec.scala#L79-L83" target="_blank" title="Go to snippet source">source</a><code class="language-scala">sealed trait Animal
case class Dog(age: Int, name: String)                      extends Animal
case class Cat(weight: Double, color: String, home: String) extends Animal
case class Fish(color: String)                              extends Animal
case object Yeti                                            extends Animal</code></pre>
<pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/sirthias/borer/tree/master/site/src/test/scala/io/bullet/borer/site/DerivationSpec.scala#L205-L217" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import io.bullet.borer.{Codec, Json}
import io.bullet.borer.derivation.MapBasedCodecs.*

// custom codec only for `Fish`
given Codec[Fish] =
  Codec.bimap[Int, Fish](_ =&gt; 0, _ =&gt; Fish(&quot;red&quot;))

// let borer derive the codecs for the rest of the Animal ADT
given Codec[Animal] = deriveAllCodecs

val animal: Animal = Fish(&quot;blue&quot;)

Json.encode(animal).toUtf8String ==&gt; &quot;&quot;&quot;{&quot;Fish&quot;:0}&quot;&quot;&quot;</code></pre>
<p>If you provide a custom codec for a whole abstract branch of the ADT hierarchy then borer will offload encoding and decoding of all sub-types of that branch to your custom codec.</p>
<h3><a href="#explicit-upcasts" name="explicit-upcasts" class="anchor"><span class="anchor-link"></span></a>Explicit Upcasts</h3>
<p>Sometimes the interplay of typeclasses and ADTs can become a bit confusing, especially when explicit upcasts are required.</p>
<p>The important thing to remember is that <em>borer&rsquo;s</em> typeclasses (<code>Encoder[T]</code>, <code>Decoder[T]</code> and <code>Codec[T]</code>) are intentionally <strong>invariant</strong> in their type parameters. This means that they will only be found and used when the types match up exactly.</p>
<p>With this ADT, for example:</p>
<pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/sirthias/borer/tree/master/site/src/test/scala/io/bullet/borer/site/DerivationSpec.scala#L79-L83" target="_blank" title="Go to snippet source">source</a><code class="language-scala">sealed trait Animal
case class Dog(age: Int, name: String)                      extends Animal
case class Cat(weight: Double, color: String, home: String) extends Animal
case class Fish(color: String)                              extends Animal
case object Yeti                                            extends Animal</code></pre>
<p>the following codec definition gives you an <code>Encoder[Animal]</code> and a <code>Decoder[Animal]</code>,<br>nothing more, nothing less:</p>
<pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/sirthias/borer/tree/master/site/src/test/scala/io/bullet/borer/site/DerivationSpec.scala#L112-L115" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import io.bullet.borer.Codec
import io.bullet.borer.derivation.MapBasedCodecs.*

given Codec[Animal] = deriveAllCodecs[Animal]</code></pre>
<p>It does <strong>not</strong> give you an <code>Encoder[Dog]</code> or a <code>Decoder[Cat]</code>!<br> If you want codecs for specific ADT sub-types like <code>Dog</code> or <code>Cat</code> you need to define them in addition to the codec for the ADT super-type, e.g. like this:</p>
<pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/sirthias/borer/tree/master/site/src/test/scala/io/bullet/borer/site/DerivationSpec.scala#L223-L228" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import io.bullet.borer.Codec
import io.bullet.borer.derivation.MapBasedCodecs.*

given Codec[Dog]    = deriveCodec[Dog]
given Codec[Cat]    = deriveCodec[Cat]
given Codec[Animal] = deriveAllCodecs[Animal]</code></pre>
<p>An alternative would be to explicitly <em>upcast</em> a value of a more specific type to the ADT super type, e.g. like this:</p>
<pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/sirthias/borer/tree/master/site/src/test/scala/io/bullet/borer/site/DerivationSpec.scala#L101-L106" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import io.bullet.borer.Json

val animal: Animal = Dog(2, &quot;Rex&quot;)

// Json.encode(animal).toByteArray or
Json.encode(animal).toUtf8String ==&gt; &quot;&quot;&quot;{&quot;Dog&quot;:{&quot;age&quot;:2,&quot;name&quot;:&quot;Rex&quot;}}&quot;&quot;&quot;</code></pre>
<p>However, note that the encoding of a <code>Dog</code> as an <code>Animal</code> is not the same as the encoding of the <code>Dog</code> itself!! The former includes the wrapping layer with the type-id while the latter doesn&rsquo;t:</p>
<pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/sirthias/borer/tree/master/site/src/test/scala/io/bullet/borer/site/DerivationSpec.scala#L233-L237" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import io.bullet.borer.Json

val dog = Dog(2, &quot;Rex&quot;)
Json.encode(dog: Animal).toUtf8String ==&gt; &quot;&quot;&quot;{&quot;Dog&quot;:{&quot;age&quot;:2,&quot;name&quot;:&quot;Rex&quot;}}&quot;&quot;&quot;
Json.encode(dog        ).toUtf8String ==&gt; &quot;&quot;&quot;{&quot;age&quot;:2,&quot;name&quot;:&quot;Rex&quot;}&quot;&quot;&quot;</code></pre>
<p>This is because the <code>Decoder[Animal]</code> needs to somehow receive the information <em>which</em> <code>Animal</code> type to decode into, while the <code>Decoder[Dog]</code> doesn&rsquo;t, as it already knows the concrete target exactly.</p>
<p>So, while explicit upcasts are sometimes what you want there are also cases where they are not what you want. The exact target types of your (de)serializations depends on your specific use case and, as such, should be chosen carefully.</p>
<h3><a href="#recursive-adts" name="recursive-adts" class="anchor"><span class="anchor-link"></span></a>Recursive ADTs</h3>
<p>Before Scala 3 the codecs for non-generic ADTs were mostly assigned to an <code>implicit val</code> in order to not be recreated on every use. If the <code>ADT</code> is recursive this <code>val</code> had to be converted into an <code>implicit lazy val</code> with an explicit type annotation instead, as in this example:</p>
<pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/sirthias/borer/tree/master/site/src/test/scala/io/bullet/borer/site/DerivationSpec.scala#L272-L279" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import io.bullet.borer.Codec
import io.bullet.borer.derivation.MapBasedCodecs.*

sealed trait TreeNode
case object Leaf                                 extends TreeNode
case class Node(left: TreeNode, right: TreeNode) extends TreeNode

implicit lazy val codec: Codec[TreeNode] = deriveAllCodecs</code></pre>
<p>While this still works with Scala 3 we can now resort to a simple <code>given</code> definition for all use-cases:</p>
<pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/sirthias/borer/tree/master/site/src/test/scala/io/bullet/borer/site/DerivationSpec.scala#L285-L292" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import io.bullet.borer.Codec
import io.bullet.borer.derivation.MapBasedCodecs.*

sealed trait TreeNode
case object Leaf                                 extends TreeNode
case class Node(left: TreeNode, right: TreeNode) extends TreeNode

given Codec[TreeNode] = deriveAllCodecs</code></pre>
<p>The Scala 3 compiler compiles all such <code>given</code> definitions into the equivalent of <code>lazy val</code>s under the hood, so we don&rsquo;t have to make the distinction ourselves anymore.</p>
</div>
<div>
<a href="https://github.com/sirthias/borer/tree/master/site/src/main/paradox/borer-derivation/faq.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
1.16.0
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../borer-derivation/type-ids.html" title="Type IDs" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Type IDs
</span>
</div>
</a>
<a href="../borer-compat-akka.html" title="borer-compat-akka" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
borer-compat-akka
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
<div class="md-footer-copyright__highlight">
Copyright (C) 2019-2023 Mathias Doenitz
</div>
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
<div class="md-footer-social">
<a href="https://github.com/sirthias" class="md-footer-social__link fa fa-github"></a><a href="https://twitter.com/sirthias" class="md-footer-social__link fa fa-twitter"></a>
</div>

</div>
</div>
</footer>

</div>
<script src="../assets/javascripts/application.583bbe55.js"></script>
<script src="../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../."}})</script>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
